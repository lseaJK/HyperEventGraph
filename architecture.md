# HyperEventGraph 架构文档

## 1. 项目概述

HyperEventGraph 是一个基于大语言模型的事件抽取和知识图谱构建系统，旨在从非结构化文本中抽取结构化的事件信息，并构建事件知识图谱。

## 2. 系统架构

### 2.1 核心模块

- **事件抽取模块** (`src/event_extraction/`)
- **知识图谱构建模块** (`src/knowledge_graph/`)
- **RAG检索模块** (`src/rag/`)
- **API服务模块** (`src/api/`)

### 2.2 事件抽取模块架构

#### 2.2.1 抽取器组件
- `extractor.py` - 基础抽取器接口
- `deepseek_extractor.py` - DeepSeek模型抽取器实现
- `event_extraction_service.py` - 事件抽取服务

#### 2.2.2 支持组件
- `schemas.py` - 事件模式定义
- `prompt_templates.py` - Prompt模板管理
- `validation.py` - 输出验证器

### 3. 技术实现细节

## 3.2 JSON解析与验证系统

### 3.2.1 JSON解析器设计

事件抽取系统采用多策略JSON解析器(`json_parser.py`)，能够处理LLM输出的各种格式：

- **直接JSON解析**：处理标准JSON格式
- **代码块解析**：提取```json```代码块中的内容
- **正则表达式提取**：使用正则匹配JSON对象
- **清理后解析**：移除非JSON前缀后解析
- **部分JSON修复**：修复常见JSON错误
- **结构化文本解析**：从自然语言中提取结构化信息

### 3.2.2 JSON解析器增强与集成 ✅

**实施状态：已完成**

#### 问题识别与解决

在系统集成测试过程中，发现了JSON解析器的几个关键问题：

1. **过度宽松的解析策略**
   - **问题**：`_parse_partial_json`方法对不完整的JSON过于宽松，导致应该失败的解析被错误地标记为成功
   - **解决方案**：添加了`_is_obviously_incomplete_json`方法来检查JSON完整性，包括括号匹配、尾随逗号和截断标志检测

2. **结构化文本解析的边界问题**
   - **问题**：`_parse_structured_text`方法会错误地解析明显不完整的JSON字符串
   - **解决方案**：添加了`_looks_like_incomplete_json`方法，在结构化文本解析前进行预检查

3. **Prompt模板占位符不一致**
   - **问题**：模板中使用了不同的占位符格式（`{input_text}`、`{{input_text}}`）
   - **解决方案**：统一使用`[待抽取文本]`占位符格式

4. **模块导入错误**
   - **问题**：存在不存在的类导入（如`EventSchema`）
   - **解决方案**：清理了无效导入，修正了模块引用

#### 技术改进

**增强的错误检测机制：**
```python
def _is_obviously_incomplete_json(self, text: str) -> bool:
    """检查JSON是否明显不完整"""
    # 检查括号匹配
    open_braces = text.count('{')
    close_braces = text.count('}')
    if open_braces > close_braces:
        return True
    
    # 检查其他不完整标志
    if text.strip().endswith(',') or '...' in text:
        return True
    
    return False
```

**智能JSON识别：**
```python
def _looks_like_incomplete_json(self, text: str) -> bool:
    """判断文本是否看起来像不完整的JSON"""
    text = text.strip()
    
    # 检查是否以JSON开始但括号不匹配
    if (text.startswith('{') or text.startswith('[')):
        open_count = text.count('{') + text.count('[')
        close_count = text.count('}') + text.count(']')
        if open_count > close_count:
            return True
    
    return False
```

#### 集成测试结果

通过全面的集成测试验证了系统的稳定性：

- ✅ **JSON解析器基本功能**：3/3 测试通过
- ✅ **输出验证器功能**：3/3 测试通过
- ✅ **Prompt模板集成**：2/2 测试通过
- ✅ **便捷函数**：1/1 测试通过

**总体测试结果：4/4 全部通过** 🎉

#### 架构影响

这次增强对整体架构产生了积极影响：

1. **提高了系统鲁棒性**：能够正确处理各种边界情况和错误输入
2. **增强了错误恢复能力**：多层次的解析策略确保了高成功率
3. **改善了开发体验**：清晰的错误信息和调试信息便于问题定位
4. **保证了数据质量**：严格的验证机制确保输出数据的可靠性

#### 性能优化

- **解析效率**：通过策略优先级排序，常见格式能够快速解析
- **内存使用**：避免了不必要的字符串复制和正则表达式编译
- **错误处理**：快速失败机制减少了无效解析尝试的开销

#### 未来扩展方向

1. **自适应解析**：根据历史成功率动态调整解析策略优先级
2. **模式学习**：从失败案例中学习新的解析模式
3. **性能监控**：添加解析性能指标收集和分析
4. **多语言支持**：扩展对不同语言JSON格式的支持

---

**总结**：3.2.2的实施显著提升了JSON解析系统的可靠性和鲁棒性，为整个事件抽取流程奠定了坚实的基础。通过系统性的问题识别、技术改进和全面测试，确保了系统在各种复杂场景下的稳定运行。

## 4. 部署与运维

### 4.1 环境要求

- Python 3.8+
- 依赖包：见 `requirements.txt`

### 4.2 配置管理

- 环境变量配置
- 模型配置文件
- 数据库连接配置

## 5. 测试策略

### 5.1 单元测试

- 各模块独立测试
- 覆盖率要求：>80%

### 5.2 集成测试

- 端到端功能测试
- 性能基准测试

### 5.3 系统测试

- 负载测试
- 稳定性测试

## 6. 监控与日志

### 6.1 日志系统

- 结构化日志记录
- 日志级别管理
- 日志轮转策略

### 6.2 性能监控

- 响应时间监控
- 资源使用监控
- 错误率统计

---

**文档版本**：v1.0  
**最后更新**：2024-01-15  
**维护者**：HyperEventGraph Team