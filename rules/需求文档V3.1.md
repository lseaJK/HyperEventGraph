# HyperEventGraph V3.1: 架构与实施蓝图

**版本**: 3.1 (Architecture & Implementation Blueprint)
**作者**: Gemini Architect
**日期**: 2025-07-27

---

## 1. 核心愿景：构建一个“活”的知识系统

我们的目标是构建一个能够**自我完善、持续迭代**的领域事件知识图谱系统。它不仅能处理一次性的数据输入，更能在一个**闭环的知识循环**中不断学习，扩大认知边界，从而实现真正的“智能”和“进化”。

---

## 2. V3.1 架构核心：中央状态驱动

系统的核心是一个**中央状态数据库 (`master_state.db`)** 和一个**中央配置文件 (`config.yaml`)**。所有工作流脚本都是无状态的，它们通过查询和更新中央数据库来协同工作，由中央配置文件统一驱动。

```
+-----------------------------------------------------------------+
|                          config.yaml                            |
| (Paths, Batch Sizes, Model Names, All System-wide Parameters)   |
+-----------------------------------------------------------------+
                                |
                                v
+-----------------------------------------------------------------+
|                       master_state.db (SQLite)                    |
| (ID, Text, Status, Confidence, Type, Notes, Timestamp)          |
+-----------------------------------------------------------------+
     ^       |           ^       |           ^       |           ^
     |       |           |       |           |       |           |
     |       v           |       v           |       v           |
+----|-------+----+ +----|-------+----+ +----|-------+----+ +----|-------+----+
| Task #13:      | | Task #14:      | | Task #15:      | | Task #16:      |
| Batch Triage   | | Human Review   | | Schema Learning| | Extraction     |
| (State: -> PM) | | (State: -> PL/PE)| | (State: -> PT) | | (State: -> C)  |
+----------------+ +----------------+ +----------------+ +----------------+
```
*（状态码：PM=Pending Review, PL=Pending Learning, PE=Pending Extraction, PT=Pending Triage, C=Completed）*

---

## 3. 核心模块实施细则 (The "How")

### 3.1. 任务 #12: 奠定基石 - 建立中央状态库与配置文件

- **目标**: 搭建整个系统的“中央神经系统”。
- **实施要点**:
  - **数据库模块**: 创建 `src/core/database_manager.py`。
    - 使用 `sqlite3` 库。
    - 定义 `MasterState` 表，字段: `id TEXT PRIMARY KEY`, `source_text TEXT`, `current_status TEXT`, `triage_confidence REAL`, `assigned_event_type TEXT`, `notes TEXT`, `last_updated TIMESTAMP`。
    - 实现所有CRUD函数 (`add_new_texts`, `get_texts_by_status`, `update_text_status` 等)。
    - 此模块将完全取代旧的 `src/workflows/state_manager.py`。
  - **配置模块**: 创建 `src/core/config_loader.py`。
    - 使用 `PyYAML` 库加载和验证 `config.yaml`。
    - 提供全局可用的 `get_config()` 函数。
  - **统一配置文件**: 创建 `config.yaml`，并将所有分散的路径、批次大小、模型名称等参数统一管理。

### 3.2. 任务 #13: 实施第一阶段 - 开发与状态库集成的批量初筛工作流

- **目标**: 高效、稳健地完成海量数据的初步分类。
- **实施要点**:
  - **重构 `run_batch_triage.py`**:
    - 必须导入并使用 `database_manager` 和 `config_loader`。
    - 主循环逻辑:
      1. 从数据库查询状态为 `pending_triage` 的数据，按批次处理。
      2. **修改 `TriageAgent` 的Prompt**，要求其在JSON输出中必须包含一个 `confidence_score` 字段。
      3. 将分类结果（事件类型、置信度）写回数据库，并将状态更新为 `pending_review`。
    - 该脚本的批处理+数据库查询/更新机制，天然地实现了检查点和断点续传。

### 3.3. 任务 #14: 实施第二阶段 - 开发支持优先级的离线人工审核工作流

- **目标**: 建立高效、聚焦的人类智慧网关。
- **实施要点**:
  - **创建 `prepare_review_file.py`**:
    - 从数据库查询所有状态为 `pending_review` 的记录。
    - **核心功能**: 按 `triage_confidence` 升序排序，让审核员优先处理AI最不确定的案例。
    - 生成 `review_sheet.csv` 供人工审核。
  - **创建 `process_review_results.py`**:
    - 读取审核完成的CSV。
    - 将每一行经过人工校准的结果，通过 `database_manager` 更新回数据库，将状态设置为 `pending_learning` 或 `pending_extraction`。

### 3.4. 任务 #15: 实施第三阶段 - 开发增强型交互式学习工作流

- **目标**: 建立一个强大的、由专家引导的知识增长引擎，并闭合迭代循环。
- **实施要点**:
  - **创建 `run_learning_workflow.py`**:
    - 从数据库查询状态为 `pending_learning` 的数据。
    - **创建 `src/agents/toolkits/schema_learning_toolkit.py`**: 封装聚类 (`scikit-learn`)、样本展示 (`pandas`) 等核心算法。
    - **实现增强型CLI**: 提供 `list_clusters`, `show_samples <id>`, `merge_clusters <id1> <id2>`, `generate_schema <id>` 等丰富的交互指令。
    - **闭合循环**: 当一��新Schema被学会并保存到 `event_schemas.json` 后，脚本必须调用 `database_manager`，将该簇内所有对应数据的状态**重置为 `pending_triage`**，使其能自动进入下一轮的分类和抽取流程。

### 3.5. 任务 #16: 实施第四阶段 - 开发批量抽取工作流

- **目标**: 将高质量的已知事件转化为最终的结构化知识。
- **实施要点**:
  - **创建 `run_extraction_workflow.py`**:
    - 从数据库查询状态为 `pending_extraction` 的数据，按批次处理。
    - 调用 `ExtractionAgent` 进行信息抽取。
    - 将最终的结构化数据保存到指定的输出位置（如另一个数据表或jsonl文件）。
    - 调用 `database_manager` 将已处理数据的状态更新为 `completed`。

### 3.6. 补充建议：统一的管理入口

- **目标**: 提升系统的整体性和易用性。
- **实施建议**:
  - 利用 `src/admin/admin_module.py` 创建一个统一的命令行入口。
  - 例如: `python -m src.admin.cli --action triage` 或 `python -m src.admin.cli --action learn`。
  - 这将使系统更像一个专业的应用程序，而非一堆独立的脚本。

---
---
*本文档是V3.1开发与实施的唯一、最终的指导方针。*
