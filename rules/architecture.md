# HyperEventGraph 双层架构设计文档

**重要提示**: 请先阅读 [`project_rules.md`](./project_rules.md) 了解项目管理规范和文档组织原则。

## 架构概述

HyperEventGraph 是一个基于大语言模型的事件抽取和知识图谱构建系统，旨在从非结构化文本中抽取结构化的事件信息，并构建事件知识图谱。该框架以`HyperGraphRAG`为核心技术，结合领域特定的事件Schema，实现从非结构化文本到智能问答的完整流水线，重点支持金融和集成电路领域的事件抽取、知识图谱构建和检索增强生成应用。

**核心价值**：
- 将复杂的领域事件表示为超关系图结构
- 支持多实体、多关系的复杂事件建模
- 提供基于知识图谱的智能检索和推理能力
- 实现端到端的事件知识管理解决方案

### 1.1 事理图谱架构设计

事理图谱是HyperEventGraph的核心知识表示形式，用于描述事件之间的演化规律和逻辑关系。<mcreference link="https://www.jiqizhixin.com/articles/2020-09-28-6" index="1">1</mcreference> <mcreference link="https://cloud.tencent.com/developer/article/1469579" index="3">3</mcreference>

#### 1.1.1 事理图谱定义

事理图谱是一个描述事件之间演化规律和模式的事理逻辑知识库。结构上，事理图谱是一个有向图，其中节点代表事件，有向边代表事件之间的顺承、因果、条件和上下位等事理逻辑关系。<mcreference link="https://www.jiqizhixin.com/articles/2020-09-28-6" index="1">1</mcreference>

**与传统知识图谱的区别：**
- **知识图谱**：以实体为节点，实体间关系为边，关系多为确定性
- **事理图谱**：以事件为节点，事件间关系为边，关系多为不确定性概率转移

#### 1.1.2 双层架构设计

事理图谱采用双层架构设计，包含事件层和事理层：

**事件层（Event Layer）：**
- **节点**：具体事件实例，包含时间、地点、参与者等具体信息
- **属性**：事件类型、触发词、论元角色、时间戳、置信度等
- **关系**：事件实例间的直接关联（共指、包含、扩展等）
- **存储**：Neo4j图数据库，支持复杂查询和事务处理

**事理层（Logic Layer）：**
- **节点**：抽象事件模式，表示为泛化的谓词短语或结构化元组
- **属性**：抽象程度、适用场景、统计频次等
- **关系**：事理逻辑关系（顺承、因果、条件、上下位）
- **权重**：转移概率、因果强度、条件置信度等

#### 1.1.3 事理逻辑关系类型

基于大规模文本统计分析，系统重点关注四种主要的事理逻辑关系：<mcreference link="https://www.jiqizhixin.com/articles/2020-09-28-6" index="1">1</mcreference> <mcreference link="https://cloud.tencent.com/developer/article/1469579" index="3">3</mcreference>

**1. 顺承关系（Succession）**
- **定义**：两个事件在时间上相继发生的偏序关系
- **特征**：前序事件的起始时间早于后序事件的起始时间
- **权重**：转移概率（0-1之间），表示演化置信度
- **示例**："公司发布财报" → "股价波动"

**2. 因果关系（Causality）**
- **定义**：前一事件（原因）的发生导致后一事件（结果）的发生
- **特征**：满足时间偏序关系，因果关系是顺承关系的子集
- **权重**：因果强度值（0-1之间），表示因果关系成立的置信度
- **示例**："央行降息" → "房地产市场活跃"

**3. 条件关系（Condition）**
- **定义**：前一个事件是后一个事件发生的必要或充分条件
- **特征**：属于逻辑关系而非客观事实关系
- **权重**：条件强度，表示条件成立的可能性
- **示例**："如果通过审核" → "那么获得贷款"

**4. 上下位关系（Hierarchy）**
- **定义**：事件之间的包含或抽象层次关系
- **特征**：上位事件包含下位事件，体现不同抽象级别
- **权重**：包含程度，表示层次关系的强度
- **示例**："金融危机" ⊃ "银行倒闭"

#### 1.1.4 事件表示格式

**结构化事件表示：**
```json
{
  "event_id": "evt_001",
  "event_type": "acquisition",
  "trigger": "收购",
  "arguments": {
    "acquirer": {"entity": "公司A", "role": "收购方"},
    "target": {"entity": "公司B", "role": "被收购方"},
    "amount": {"entity": "350亿美元", "role": "金额"},
    "time": {"entity": "2024年1月", "role": "时间"},
    "location": {"entity": "北京", "role": "地点"}
  },
  "confidence": 0.95,
  "timestamp": "2024-01-15T10:30:00Z",
  "source": "financial_news_001"
}
```

**抽象事件模式：**
```json
{
  "pattern_id": "pattern_acquisition",
  "abstract_form": "(收购方, 收购, 被收购方)",
  "semantic_roles": ["agent", "action", "patient"],
  "optional_roles": ["amount", "time", "location"],
  "abstraction_level": "medium",
  "frequency": 1250,
  "domains": ["finance", "business"]
}
```

## 核心组件

### 1. 双层架构核心类 (DualLayerArchitecture)
**功能**：集成事件层和模式层管理
- 统一管理双层架构的所有组件
- 提供高层次的API接口
- 协调层间数据流和处理逻辑
- 实现跨层查询和分析功能

### 2. 事件层管理器 (EventLayerManager)
**功能**：负责具体事件实例的存储和查询
- 事件实例的CRUD操作
- 事件时序查询和过滤
- 事件相似性计算和匹配
- 事件关系分析和维护

### 3. 模式层管理器 (PatternLayerManager)
**功能**：负责抽象事理模式的学习和管理
- 事理模式的抽取和存储
- 模式匹配和相似性分析
- 模式演化和更新机制
- 跨模式关联分析

### 4. 层间映射器 (LayerMapper)
**功能**：实现双层间的映射和转换机制
- 事件实例到模式的抽象映射
- 模式到具体事件的实例化
- 跨层推理和知识传递
- 一致性维护和同步机制

### 5. 图处理器 (GraphProcessor)
**功能**：提供复杂查询和分析功能
- 图算法和路径分析
- 事件预测和推理
- 因果关系挖掘
- 时序模式识别

### 6. 事件数据模型 (event_data_model.py)
**功能**：完整的数据结构定义
- Event：事件实体定义
- EventPattern：事理模式定义
- Entity：实体对象定义
- 关系类型和属性规范

### 7. Neo4j存储层 (neo4j_event_storage.py)
**功能**：数据持久化实现
- Neo4j数据库连接和操作
- 事件和模式的存储优化
- 索引和查询性能优化
- 数据一致性保障

## 当前双层架构状态

### 🏗️ 核心架构
- ✅ 事件层：完整实现事件存储、查询、分析功能
- ✅ 模式层：实现模式抽取、匹配、管理功能
- ✅ 层间映射：完整的双层映射和转换机制

### 📊 数据模型
- ✅ Event：事件实体模型完备，支持多维属性
- ✅ EventPattern：事理模式模型完整，支持抽象表述
- ✅ Entity：实体模型规范，支持多类型实体
- ✅ 关系模型：完整的关系类型定义和属性规范

### 💾 存储层
- ✅ Neo4j集成：完整的图数据库集成
- ✅ 事件存储：支持高效的事件数据存储和检索
- ✅ 模式存储：支持抽象模式的持久化管理
- ✅ 性能优化：索引策略和查询优化

### 🔍 查询功能
- ✅ 事件查询：多维度事件检索和过滤
- ✅ 相似性分析：事件和模式的相似性计算
- ✅ 模式匹配：高效的模式匹配算法
- ✅ 跨层查询：支持事件层和模式层的联合查询

### 🧠 智能功能
- ✅ 模式学习：从事件实例中自动抽取事理模式
- ✅ 事件预测：基于历史模式预测未来事件
- ✅ 跨层推理：利用双层架构进行复杂推理
- ✅ 知识发现：挖掘隐含的事理关系和规律

## 技术特点

### 1. 双层表述体系
- **事件层**：存储具体的事件实例，保持事件的完整性和真实性
- **模式层**：抽象事理模式，捕获事件间的普遍规律和因果关系
- **层间映射**：实现具体与抽象的双向转换，支持多层次推理

### 2. 图数据库优化
- 基于Neo4j的高性能图存储
- 针对事理图谱的索引策略
- 支持大规模事件数据的高效查询

### 3. 智能分析能力
- 事件相似性计算和聚类
- 时序模式识别和预测
- 因果关系挖掘和推理
- 跨层知识发现和传递

### 4. 可扩展架构
- 模块化设计，支持功能扩展
- 标准化接口，便于集成其他系统
- 灵活的配置机制，适应不同应用场景

## 应用场景

1. **智能问答系统**：基于事理图谱的知识检索和推理
2. **事件预测分析**：利用历史模式预测未来事件发展
3. **因果关系挖掘**：发现事件间的深层因果联系
4. **决策支持系统**：提供基于事理知识的智能决策建议
5. **知识图谱构建**：自动化的大规模事理知识图谱构建

## 发展规划

### 短期目标
- 完善RAG功能集成
- 优化查询性能和用户体验
- 扩展支持的事件类型和领域

### 中期目标
- 多模态事件处理能力
- 实时事件流处理
- 分布式架构支持

### 长期目标
- 通用事理知识图谱平台
- 跨领域知识融合
- 智能决策生态系统