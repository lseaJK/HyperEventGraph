# HyperEventGraph 项目任务清单

## 项目概述
**项目名称**: HyperEventGraph - 基于事理图谱的增强检索生成系统
**技术栈**: ChromaDB + Neo4j + BGE嵌入模型 + LLM
**核心目标**: 构建双层事理图谱，实现GraphRAG增强的知识检索与生成
**目标**: 构建基于双层架构的事理图谱系统，实现事件抽取、关系分析、GraphRAG增强和标准化输出
**当前状态**: 基础模块已实现，需要补充事理关系分析和GraphRAG增强功能
**关键里程碑**: 事理关系识别 → 标准化输出 → GraphRAG增强 → 系统集成

## 开发规则

### 核心原则
1. **单一任务完成原则**：只需要完成当前一个指令，形成可测试的代码并通过测试
2. **主功能优先原则**：注重于主功能的实现，避免过度设计和功能膨胀
3. **模块化整合原则**：接受到任务先查看已有代码能否提供思路，最终目标是整合成模块化的文档，消除之前边界不清的问题

### 实施要求
- 每个任务必须有明确的输入、输出和验收标准
- 代码实现必须可测试，包含单元测试
- 优先复用现有代码和模块，避免重复开发
- 模块边界清晰，接口定义明确
- 每次提交的代码必须能够独立运行和测试

### 项目开发规则
- **简化优先原则**：在项目构建阶段，优先保证主程序清晰、能够运行，避免过度复杂的架构设计
- **功能渐进原则**：先实现核心功能，后续再考虑扩展功能和优化
- **实用性原则**：所有设计和实现都应以实际需求为导向，避免过度工程化
- **核心功能优先**：集中资源实现事理图谱双层架构，性能优化和质量控制降低优先级

---
## 阶段1：事理关系分析器开发
**目标**: 实现多事件间的事理关系识别和分析
**优先级**: 🔥 最高优先级

### 1.1 事理关系分析器核心实现
- [x] 创建 `src/event_logic/event_logic_analyzer.py`
  - **输入**: List[Event] - 结构化事件列表
  - **输出**: List[EventRelation] - 事件关系列表
  - **验收标准**: 能识别因果、时序、条件、对比四种基本关系类型
  - ✅ **已完成**: EventLogicAnalyzer类已实现，支持所有基本关系类型

- [x] 实现关系识别接口 `analyze_event_relations(events: List[Event]) -> List[EventRelation]`
  - **功能**: 基于LLM的事理关系识别
  - **验收标准**: 单次调用能处理10-50个事件，返回结构化关系数据
  - ✅ **已完成**: 已实现LLM和规则双重分析方法

- [x] 实现批量关系分析 `batch_analyze_relations(event_batches: List[List[Event]]) -> Dict[str, List[EventRelation]]`
  - **功能**: 支持大规模事件的批量关系分析
  - **验收标准**: 支持并发处理，错误处理机制完善
  - ✅ **已完成**: 支持批量处理和错误处理机制

### 1.2 关系验证器实现
- [x] 创建 `src/event_logic/relationship_validator.py`
  - **输入**: EventRelation - 候选关系
  - **输出**: ValidatedRelation - 验证后的关系(含置信度)
  - **验收标准**: 能过滤明显错误的关系，置信度评分合理
  - ✅ **已完成**: RelationshipValidator类已实现完整验证功能

- [x] 实现关系一致性检查
  - **功能**: 检查关系的逻辑一致性(如循环因果)
  - **验收标准**: 能发现并标记逻辑冲突
  - ✅ **已完成**: 包含循环检测、传递性验证等一致性检查

### 1.3 数据结构定义
- [x] 创建 `src/event_logic/data_models.py`
  - **内容**: EventRelation, RelationType, ValidationResult等数据类
  - **验收标准**: 支持JSON序列化，字段完整
  - ✅ **已完成**: 完整的数据模型定义，支持JSON序列化

### 1.4 单元测试
- [x] 创建 `tests/test_event_logic_analyzer.py`
  - **覆盖**: 关系识别、批量处理、错误处理
  - **验收标准**: 测试覆盖率>80%

- [x] 收集真实新闻数据进行测试
  - **功能**: 通过网络搜索获取真实新闻事件，替换当前的模拟测试数据
  - **输入**: 网络搜索的真实新闻文本
  - **输出**: 保存为测试数据文件，用于事理关系分析器的真实场景测试
  - **验收标准**: 获取至少5-10条真实新闻，涵盖不同事件类型，测试数据符合真实分布
  - ✅ **已完成**: 收集了10条2024年真实新闻，涵盖政治、经济、科技、军事、国际等多个类别
  - ✅ **已创建**: `real_news_test_data.py` - 真实新闻数据集
  - ✅ **已创建**: `test_real_news.py` - 真实新闻数据测试文件

---

## 阶段2：标准化输出管理器开发
**目标**: 实现JSONL格式输出和图谱导出功能
**优先级**: 🔥 高优先级

### 2.1 JSONL输出管理器
- [x] 创建 `src/output/jsonl_manager.py`
  - **输入**: List[Event], List[EventRelation]
  - **输出**: JSONL文件
  - **验收标准**: 输出格式符合标准，支持增量写入
  - ✅ **已完成**: JSONLManager类已实现，支持事件、关系、合并数据输出

- [x] 实现标准化事件格式转换
  - **功能**: Event对象转换为标准JSONL格式
  - **验收标准**: 字段完整，格式规范，支持嵌套属性
  - ✅ **已完成**: 已实现事件数据的JSONL格式转换

- [x] 实现关系数据序列化
  - **功能**: EventRelation转换为JSONL关系格式
  - **验收标准**: 关系类型、置信度、时间戳等信息完整
  - ✅ **已完成**: 已实现关系数据的JSONL格式输出

### 2.2 图谱导出管理器
- [x] 创建 `src/output/graph_exporter.py`
  - **输入**: Neo4j图数据
  - **输出**: GraphML/GEXF格式文件
  - **验收标准**: 支持多种图格式，保持节点和边的属性
  - ✅ **已完成**: GraphExporter类已实现，支持GraphML和GEXF导出

- [x] 实现图谱可视化数据生成
  - **功能**: 生成适用于可视化工具的数据格式
  - **验收标准**: 支持Gephi、Cytoscape等主流工具
  - ✅ **已完成**: 已支持Gephi、Cytoscape等主流可视化工具格式

### 2.3 输出格式验证
- [x] 创建 `src/output/format_validator.py`
  - **功能**: 验证输出文件的格式正确性
  - **验收标准**: 能检测格式错误，提供详细错误信息
  - ✅ **已完成**: FormatValidator类已实现，支持多种格式验证

### 2.4 单元测试
- [x] 创建 `tests/test_output_managers.py`
  - **覆盖**: JSONL输出、图谱导出、格式验证
  - **验收标准**: 测试覆盖率>80%
  - ✅ **已完成**: 完整的单元测试已实现，覆盖所有核心功能

---

## 阶段3：GraphRAG增强器开发
**目标**: 实现基于图谱的检索增强生成功能
**优先级**: 🟡 中等优先级

### 3.1 混合检索器实现
- [ ] 创建 `src/event_logic/hybrid_retriever.py`
  - **输入**: Event - 查询事件
  - **输出**: HybridSearchResult - 混合检索结果(ChromaDB+Neo4j)
  - **验收标准**: 集成ChromaDB向量检索和Neo4j图结构检索

- [ ] 实现BGE嵌入向量化
  - **功能**: 使用Ollama `smartcreation/bge-large-zh-v1.5:latest`对事件进行向量化
  - **验收标准**: 向量化准确，支持批量处理

- [ ] 实现ChromaDB向量检索
  - **功能**: 基于BGE向量在ChromaDB中检索相似事件
  - **验收标准**: 检索精度高，响应时间<300ms

- [ ] 实现Neo4j子图检索
  - **功能**: 基于ChromaDB候选集在Neo4j中获取结构化子图
  - **验收标准**: 子图完整，包含关系上下文

- [ ] 实现混合检索融合策略
  - **功能**: 加权融合语义相似度和结构相似度得分
  - **验收标准**: 融合结果相关性优于单一检索方式

### 3.2 属性补充器实现
- [ ] 创建 `src/event_logic/attribute_enhancer.py`
  - **输入**: IncompleteEvent - 不完整事件
  - **输出**: EnhancedEvent - 补充属性后的事件
  - **验收标准**: 能基于ChromaDB+Neo4j的历史数据推理缺失属性

- [ ] 实现BGE向量化属性检索
  - **功能**: 对不完整事件进行BGE向量化，在ChromaDB中检索同类型事件
  - **验收标准**: 检索到的同类型事件相关性>0.8

- [ ] 实现Neo4j关联属性查询
  - **功能**: 基于ChromaDB候选事件，在Neo4j中查询关联属性和上下文
  - **验收标准**: 能获取完整的属性关联图谱

- [ ] 实现属性模板生成
  - **功能**: 统计ChromaDB检索结果的属性分布，生成属性模板
  - **验收标准**: 模板覆盖率>70%，推理准确率>60%

- [ ] 实现属性补充验证
  - **功能**: 基于Neo4j图谱上下文验证补充属性的合理性
  - **验收标准**: 验证准确率>80%，避免逻辑冲突

### 3.3 模式发现器实现
- [ ] 创建 `src/event_logic/pattern_discoverer.py`
  - **输入**: List[Event] - 事件序列
  - **输出**: List[EventPattern] - 发现的事理模式
  - **验收标准**: 基于ChromaDB聚类和Neo4j图遍历发现事理模式

- [ ] 实现BGE批量向量化
  - **功能**: 对事件序列进行批量BGE向量化处理
  - **验收标准**: 支持大批量处理，向量化效率高

- [ ] 实现ChromaDB聚类分析
  - **功能**: 基于BGE向量在ChromaDB中进行事件聚类分析
  - **验收标准**: 聚类结果合理，能识别相似事件群组

- [ ] 实现Neo4j频繁子图发现
  - **功能**: 在Neo4j中使用图遍历算法发现频繁出现的事件子图
  - **验收标准**: 能发现有意义的事理模式，频率阈值可配置

- [ ] 实现模式抽象与验证
  - **功能**: 将频繁子图抽象为事理模式，并通过LLM验证语义合理性
  - **验收标准**: 抽象模式具有通用性，语义验证准确率>85%

- [ ] 实现模式存储到ChromaDB和Neo4j
  - **功能**: 将验证后的事理模式同时存储到ChromaDB(向量)和Neo4j(结构)
  - **验收标准**: 存储完整，支持后续检索和复用

### 3.4 GraphRAG协调器
- [ ] 创建 `src/event_logic/graphrag_coordinator.py`
  - **功能**: 协调ChromaDB+Neo4j的混合检索、属性补充、模式发现流程
  - **验收标准**: ChromaDB和Neo4j协作顺畅，支持并发处理

- [ ] 实现ChromaDB连接管理
  - **功能**: 管理ChromaDB连接池，支持BGE向量的存储和检索
  - **验收标准**: 连接稳定，支持高并发访问

- [ ] 实现Neo4j连接管理
  - **功能**: 管理Neo4j连接池，支持图结构的查询和更新
  - **验收标准**: 连接稳定，事务处理正确

- [ ] 实现混合检索协调
  - **功能**: 协调ChromaDB向量检索和Neo4j图检索的执行顺序和结果融合
  - **验收标准**: 检索效率高，结果融合合理

- [ ] 实现数据同步机制
  - **功能**: 确保ChromaDB和Neo4j之间的数据一致性
  - **验收标准**: 数据同步及时，一致性检查通过

### 3.5 单元测试
- [ ] 创建 `tests/test_graphrag_enhancer.py`
  - **覆盖**: 子图检索、属性补充、模式发现
  - **验收标准**: 测试覆盖率>75%

---

## 阶段4：工作流控制器与系统集成
**目标**: 实现端到端的数据处理流水线
**优先级**: 🟡 中等优先级

### 4.1 工作流控制器实现
- [ ] 创建 `src/core/workflow_controller.py`
  - **功能**: 协调各模块的执行顺序和数据传递，管理ChromaDB和Neo4j的协同工作
  - **验收标准**: 支持6阶段流水线，错误恢复机制完善，双数据库协调正常

- [ ] 实现数据流管道
  - **功能**: 文本输入 → 事件抽取 → 关系分析 → GraphRAG增强 → 存储 → 输出
  - **验收标准**: 端到端处理成功率>95%，ChromaDB和Neo4j数据一致性保证

- [ ] 实现数据库状态监控
  - **功能**: 监控ChromaDB和Neo4j的运行状态和数据同步情况
  - **验收标准**: 监控指标完整，异常告警及时，支持故障自动恢复

### 4.2 现有模块增强
- [ ] 增强 `src/core/graph_processor.py`
  - **功能**: 集成事理关系分析功能，支持ChromaDB和Neo4j双写
  - **验收标准**: 支持事理关系的识别和处理，数据同步到两个数据库

- [ ] 增强 `src/storage/event_layer_manager.py`
  - **功能**: 支持事理关系的存储和查询，管理Neo4j事件层数据
  - **验收标准**: 事理关系存储完整，查询效率高，与ChromaDB数据保持一致

- [ ] 增强 `src/storage/pattern_layer_manager.py`
  - **功能**: 支持事理模式的管理，协调ChromaDB向量存储和Neo4j结构存储
  - **验收标准**: 模式存储和检索功能完善，双数据库数据一致性保证

- [ ] 增强 `src/rag/knowledge_retriever.py`
  - **功能**: 集成ChromaDB向量检索和Neo4j图检索的混合检索能力
  - **验收标准**: 检索准确率提升，支持多种检索策略，结果融合合理

### 4.3 配置管理
- [ ] 更新 `config/settings.yaml`
  - **新增配置**: ChromaDB连接配置、BGE模型配置、事理关系分析参数、GraphRAG配置
  - **验收标准**: 配置项完整，支持环境切换，双数据库配置正确

- [ ] 创建 `config/model_config.yaml`
  - **功能**: LLM模型配置、BGE嵌入模型配置和提示词模板
  - **验收标准**: 模型配置灵活，提示词可定制，Ollama模型路径正确

- [ ] 创建 `config/database_config.yaml`
  - **功能**: ChromaDB和Neo4j的详细连接配置和性能参数
  - **验收标准**: 数据库配置完整，连接池参数合理，支持集群配置

- [ ] 创建 `src/config/workflow_config.py`
  - **功能**: 统一管理各模块的配置参数
  - **验收标准**: 支持环境变量，配置热更新

### 4.4 集成测试
- [ ] 创建 `tests/test_integration.py`
  - **覆盖**: 端到端流水线测试
  - **验收标准**: 完整流程测试通过，性能达标

---

## 阶段5：系统优化与文档完善
**目标**: 优化系统性能，完善文档和示例
**优先级**: 🟢 低优先级

### 5.1 性能优化
- [ ] 数据库查询优化
  - **功能**: 优化Neo4j查询性能和ChromaDB向量检索性能，添加必要索引
  - **验收标准**: Neo4j查询响应时间<200ms，ChromaDB检索时间<150ms，支持并发访问

- [ ] BGE向量化性能优化
  - **功能**: 优化BGE模型的批量向量化处理，支持GPU加速
  - **验收标准**: 向量化速度提升3倍以上，支持大批量处理

- [ ] 混合检索性能优化
  - **功能**: 优化ChromaDB和Neo4j的并行检索和结果融合算法
  - **验收标准**: 混合检索响应时间<300ms，准确率保持不变

- [ ] 内存管理优化
  - **功能**: 优化大规模数据处理的内存使用，包括向量缓存管理
  - **验收标准**: 内存使用稳定，无内存泄漏，向量缓存命中率>80%

- [ ] 并发处理优化
  - **功能**: 优化多线程和异步处理性能，支持数据库连接池
  - **验收标准**: 并发处理能力提升50%以上，数据库连接复用率>90%

- [ ] 优化事理关系分析性能
  - **目标**: 处理速度提升30%
  - **验收标准**: 基准测试通过

### 5.2 错误处理与监控
- [ ] 实现全局错误处理机制
  - **功能**: 统一的异常处理和日志记录，包括数据库连接异常处理
  - **验收标准**: 错误信息详细，支持错误恢复，数据库故障自动切换

- [ ] 添加双数据库监控
  - **功能**: ChromaDB和Neo4j的性能指标监控和告警机制
  - **验收标准**: 监控覆盖率>90%，告警及时准确，数据一致性监控

- [ ] BGE模型监控
  - **功能**: Ollama BGE模型的运行状态和性能监控
  - **验收标准**: 模型可用性监控，向量化性能追踪，异常自动重启

- [ ] 日志系统完善
  - **功能**: 结构化日志记录和分析，包括数据库操作日志
  - **验收标准**: 日志信息完整，支持问题追踪，数据库操作可审计

### 5.3 文档完善
- [ ] 更新API文档
  - **内容**: 所有新增模块的API说明，包括ChromaDB和Neo4j接口
  - **验收标准**: 文档完整，示例代码可运行，数据库操作示例完整

- [ ] 创建使用指南
  - **内容**: 端到端使用示例和最佳实践，包括BGE模型配置和双数据库部署
  - **验收标准**: 新用户能快速上手，数据库配置正确

- [ ] 编写部署文档
  - **内容**: ChromaDB、Neo4j、Ollama BGE模型的详细部署指南
  - **验收标准**: 支持Docker部署，生产环境配置完整，性能调优指南清晰

### 5.4 示例和测试数据
- [ ] 准备标准测试数据集
  - **内容**: 包含各种事件类型和关系的测试数据
  - **验收标准**: 数据质量高，覆盖面广

- [ ] 创建完整示例
  - **内容**: 从原始文本到最终输出的完整示例
  - **验收标准**: 示例具有代表性，结果可验证

---

## 项目管理

### 质量控制
- **代码审查**: 每个模块完成后进行代码审查
- **测试覆盖率**: 保持>75%的测试覆盖率
- **文档同步**: 代码变更时同步更新文档

### 风险控制
- **技术风险**: LLM API稳定性，Neo4j性能瓶颈
- **进度风险**: 复杂模块开发周期可能延长
- **质量风险**: 事理关系识别准确率可能不达预期

### 成功标准
1. ✅ 事理关系识别准确率>75%
2. ✅ 端到端处理成功率>95%
3. ✅ 输出格式完全符合JSONL标准
4. ✅ GraphRAG功能显著提升事件信息完整度
5. ✅ 系统支持1000+事件的批量处理
6. ✅ 所有核心功能有完整的单元测试和集成测试

---

## 备注
- 每个阶段完成后进行阶段性验收
- 优先实现核心功能，后续迭代优化性能
- 保持与现有代码的兼容性
- 所有新增代码遵循项目的编码规范

**Repository**: https://github.com/lseaJK/HyperEventGraph
